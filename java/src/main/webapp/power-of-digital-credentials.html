<html>
<head>
<title>Digital Identifiers</title>
<script>
  // function setCookie(cname, cvalue, exdays) {
  //   var d = new Date();
  //   d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
  //   var expires = "expires="+d.toUTCString();
  //   document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
  // }

  // function getCookie(cname) {
  //   var name = cname + "=";
  //   var ca = document.cookie.split(';');
  //   for(var i = 0; i < ca.length; i++) {
  //     var c = ca[i];
  //     while (c.charAt(0) == ' ') {
  //       c = c.substring(1);
  //     }
  //     if (c.indexOf(name) == 0) {
  //       return c.substring(name.length, c.length);
  //     }
  //   }
  //   return "";
  // }

  // function deleteCookie(cname) {
  //   document.cookie = cname + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
  //   allWalletIds = [];
  //   trusteeWalletId = 0;
  //   authorWalletId = 0;
  //   endorserWalletId = 0;
  //   proverWalletId = 0;
  //   verifierWalletId = 0;

  // }

  // function saveWalletId(walletId, who) {
  //   let idIndex = -1;
  //   if(who === 'trustee') idIndex = 0;
  //   else if(who === 'author') idIndex = 1;
  //   else if(who === 'endorser') idIndex = 2;
  //   else if(who === 'prover') idIndex = 3;
  //   else if(who === 'verifier') idIndex = 4;

  //   let _walletIds = getWalletIds();
  //   _walletIds[idIndex] = walletId;
  //   setCookie('walletIds', _walletIds.toString(), 1000);
  //   console.log('saved walletIds: ', _walletIds);
  // }

  // function getWalletIds() {
  //   let _walletIds = getCookie('walletIds');
  //   console.log('walletIds from cookie: ', _walletIds);
  //   if (_walletIds != "") {
  //     _walletIds = _walletIds.split(',');
  //     for(var i=0; i<_walletIds.length; i++) { _walletIds[i] = parseInt(_walletIds[i], 10); }
  //   } else {
  //     _walletIds = [0,0,0,0,0];
  //   }
  //   console.log('found walletIds: ', _walletIds);
  //   return _walletIds;
  // }

  function deleteAgentData() {
    localStorage.removeItem('agentData');
  }

  //document.getElementById('issuerStep1').addEventListener('click', issuerStep1);
  //document.cookie = "username=John Doe; expires=Thu, 18 Dec 2013 12:00:00 UTC; path=/";
  //var allWalletIds = getWalletIds();

  var restProtocol = 'http';
  var restHost = 'localhost';
  var restPort = 9000;
  var agentData = localStorage.getItem('agentData');
  if(agentData == null) {
    agentData = {
      masterSecretId: '6265b3f9-ca0d-454c-b03d-dbad0a314dc8',
      trusteeWalletId: 0,
      authorWalletId: 0,
      endorserWalletId: 0,
      proverWalletId: 0,
      verifierWalletId: 0
    };
  } else {
    agentData = JSON.parse(agentData);
  }
  console.log('Using agentData: ', agentData);

  // agentData.trusteeWalletId = allWalletIds[0];
  // agentData.authorWalletId = allWalletIds[1];
  // agentData.endorserWalletId = allWalletIds[2];
  // agentData.proverWalletId = allWalletIds[3];
  // agentData.verifierWalletId = allWalletIds[4];

  async function credentialApi(action) {

    let actionMethod = 'GET'
    let actionUri = 'api/'
    let actionBody = ''

    if(action === 'createTrusteeWallet') {
      actionMethod = 'GET'
      actionUri = actionUri + 'trustee/createWallet/' + agentData.trusteeWalletId
    } else if(action === 'createAuthorWallet') {
      actionMethod = 'GET'
      actionUri = actionUri + 'author/createWallet/' + agentData.authorWalletId
    } else if(action === 'createEndorserWallet') {
      actionMethod = 'GET'
      actionUri = actionUri + 'endorser/createWallet/' + agentData.endorserWalletId
    } else if(action === 'createProverWallet') {
      actionMethod = 'GET'
      actionUri = actionUri + 'prover/createWallet/' + agentData.proverWalletId
    } else if(action === 'addAuthor') {
      actionMethod = 'POST'
      actionUri = actionUri + 'trustee/addAuthor/' + agentData.trusteeWalletId
      actionBody = JSON.stringify({
        trusteeDid: agentData.trusteeDid,
        authorDid: agentData.authorDid,
        authorVerkey: agentData.authorVerkey
      })
    } else if(action === 'addEndorser') {
      actionMethod = 'POST'
      actionUri = actionUri + 'trustee/addEndorser/' + agentData.trusteeWalletId
      actionBody = JSON.stringify({
        trusteeDid: agentData.trusteeDid,
        endorserDid: agentData.endorserDid,
        endorserVerkey: agentData.endorserVerkey
      })
    } else if(action === 'createSchema') {
      actionMethod = 'POST'
      actionUri = actionUri + 'author/createSchema/' + agentData.authorWalletId
      actionBody = JSON.stringify({
        endorserDid: agentData.endorserDid,
        authorDid: agentData.authorDid,
        schemaName: document.getElementById('schemaName').value,
        schemaVersion: document.getElementById('schemaVersion').value,
        schemaAttributes: document.getElementById('schemaAttributes').value.split(",")
      })
    } else if(action === 'signAndSubmitRequest') {
      actionMethod = 'POST'
      actionUri = actionUri + 'endorser/signAndSubmitRequest/' + agentData.endorserWalletId
      actionBody = JSON.stringify({
        endorserDid: agentData.endorserDid,
        requestSignedByAuthor: agentData.signedSchemaRequest
      })
    } else if(action === 'createCredDef') {
      actionMethod = 'POST'
      actionUri = actionUri + 'author/createCredDef/' + agentData.authorWalletId
      actionBody = JSON.stringify({
        schemaJson: agentData.schemaJson,
        authorDid: agentData.authorDid,
        credDefTag: document.getElementById('credDefTag').value
      })
    } else if(action === 'createMasterSecret') {
      actionMethod = 'POST'
      actionUri = actionUri + 'prover/createMasterSecret/' + agentData.proverWalletId
      actionBody = JSON.stringify({
        masterSecretId: agentData.masterSecretId
      })
    } else if(action === 'createCredOffer') {
      actionMethod = 'POST'
      actionUri = actionUri + 'author/createCredOffer/' + agentData.authorWalletId
      actionBody = JSON.stringify({
        credDefId: agentData.credDefId
      })
    } else if(action === 'createCredRequest') {
      actionMethod = 'POST'
      actionUri = actionUri + 'prover/createCredRequest/' + agentData.proverWalletId
      actionBody = JSON.stringify({
        credOffer: agentData.credOffer,
        credDefJson: agentData.credDefJson,
        proverDid: agentData.proverDid
      })
    } else if(action === 'createCredential') {
      actionMethod = 'POST'
      actionUri = actionUri + 'author/createCredential/' + agentData.authorWalletId
      actionBody = JSON.stringify({
        credOffer: agentData.credOffer,
        credReqJson: agentData.credReqJson
      })
    } else if(action === 'saveCredential') {
      actionMethod = 'POST'
      actionUri = actionUri + 'prover/saveCredential/' + agentData.proverWalletId
      actionBody = JSON.stringify({
        credential: agentData.credential,
        credDefJson: agentData.credDefJson,
        credReqMetadataJson: agentData.credReqMetadataJson
      })
    } else if(action === 'createProofRequest') {
      actionMethod = 'GET'
      actionUri = actionUri + 'verifier/createProofRequest/' + agentData.verifierWalletId
    } else if(action === 'createProof') {
      actionMethod = 'POST'
      actionUri = actionUri + 'prover/createProof/' + agentData.proverWalletId
      actionBody = JSON.stringify({
        proofReqJson: agentData.proofRequestJson,
        credDefJson: agentData.credDefJson,
        schemaId: agentData.schemaId,
        schemaJson: agentData.schemaJson,
        credDefId: agentData.credDefId
      })
    } else if(action === 'verifyProof') {
      actionMethod = 'POST'
      actionUri = actionUri + 'verifier/verifyProof/' + agentData.verifierWalletId
      actionBody = JSON.stringify({
        proofJson: agentData.proofJson,
        proofRequestJson: agentData.proofRequestJson,
        schemas: agentData.schemas,
        credentialDefs: agentData.credentialDefs
      })
    } else if(action === 'signupForWalletAsTrustee' ||
              action === 'signupForWalletAsAuthor' ||
              action === 'signupForWalletAsProver' ||
              action === 'signupForWalletAsVerifier' ||
              action === 'signupForWalletAsEndorser') {
      if((agentData.trusteeWalletId != 0 && action === 'signupForWalletAsTrustee') ||
         (agentData.authorWalletId != 0 && action === 'signupForWalletAsAuthor') ||
         (agentData.proverWalletId != 0 && action === 'signupForWalletAsProver') ||
         (agentData.verifierWalletId != 0 && action === 'signupForWalletAsVerifier') ||
         (agentData.endorserWalletId != 0 && action === 'signupForWalletAsEndorser')) {
        console.log("The action '" + action + "' has already been invoked. Verify the walletIds: ", agentData);
        return;
      } else {
        actionMethod = 'POST'
        actionUri = actionUri + 'wallets/createBrandNewWallet'
        actionBody = JSON.stringify({
          secure: false
        })
      }
    }


    const fetchOptions = {
      method: actionMethod,
      headers: {
        'Content-Type': 'application/json'
      }
    }
    if(actionMethod === 'POST') {
        fetchOptions.body = actionBody
    }

    const response = await fetch(
      `${restProtocol}://${restHost}:${restPort}/${actionUri}`,
      fetchOptions
    )
    const answer = await response.json()
    console.log(action + " answer: ", answer)

    if (response.status == 200) {
      if(action === 'createTrusteeWallet') {
        agentData.trusteeDid = answer.trusteeDid
      } else if(action === 'createAuthorWallet') {
        agentData.authorDid = answer.authorDid
        agentData.authorVerkey = answer.authorVerkey
      } else if(action === 'createEndorserWallet') {
        agentData.endorserDid = answer.endorserDid
        agentData.endorserVerkey = answer.endorserVerkey
      } else if(action === 'createProverWallet') {
        agentData.proverDid = answer.proverDid
        agentData.proverVerkey = answer.proverVerkey
      } else if(action === 'addAuthor') {

      } else if(action === 'addEndorser') {

      } else if(action === 'createSchema') {
        agentData.signedSchemaRequest = answer.signedSchemaRequest
        agentData.schemaJson = answer.schemaJson
        agentData.schemaId = answer.schemaId
      } else if(action === 'createCredDef') {
        agentData.credDefId = answer.credDefId
        agentData.credDefJson = answer.credDefJson
      } else if(action === 'createCredOffer') {
        agentData.credOffer = answer.credOffer
      } else if(action === 'createCredRequest') {
        agentData.credReqMetadataJson = answer.credReqMetadataJson
        agentData.credReqJson = answer.credReqJson
      } else if(action === 'createCredential') {
        agentData.credential = answer.credential
      } else if(action === 'saveCredential') {

      } else if(action === 'createProofRequest') {
        agentData.proofRequestJson = answer.proofRequestJson
      } else if(action === 'createProof') {
        agentData.proofJson = answer.proofJson
        agentData.schemas = answer.schemas
        agentData.credentialDefs = answer.credentialDefs
      } else if(action === 'verifyProof') {
        agentData.proved = answer.proved
      } else if(action === 'signupForWalletAsTrustee') {
        agentData.trusteeWalletId = answer.walletId
      } else if(action === 'signupForWalletAsAuthor') {
        agentData.authorWalletId = answer.walletId
      } else if(action === 'signupForWalletAsEndorser') {
        agentData.endorserWalletId = answer.walletId
      } else if(action === 'signupForWalletAsProver') {
        agentData.proverWalletId = answer.walletId
      } else if(action === 'signupForWalletAsVerifier') {
        agentData.verifierWalletId = answer.walletId
      }

      localStorage.setItem("agentData", JSON.stringify(agentData));
    }
  }


</script>
</head>
<body>
<h1>Power Of Digital Credentials</h1>
<h2>Do these steps ONLY once</h2>
<button id="signupForWalletAsTrustee" onclick="credentialApi('signupForWalletAsTrustee')">Trustee: Step1 -- signupForWallet</button>
</br><button id="createTrusteeWallet" onclick="credentialApi('createTrusteeWallet')">Trustee: Step2 -- createTrusteeWallet</button>
</br><button id="signupForWalletAsAuthor" onclick="credentialApi('signupForWalletAsAuthor')">Author: Step3 -- signupForWallet</button>
</br><button id="createAuthorWallet" onclick="credentialApi('createAuthorWallet')">Author: Step4 -- createAuthorWallet</button>
</br><button id="signupForWalletAsEndorser" onclick="credentialApi('signupForWalletAsEndorser')">Endorser: Step5 -- signupForWallet</button>
</br><button id="createEndorserWallet" onclick="credentialApi('createEndorserWallet')">Endorser: Step6 -- createEndorserWallet</button>
</br><button id="signupForWalletAsProver" onclick="credentialApi('signupForWalletAsProver')">Prover: Step7 -- signupForWallet</button>
</br><button id="createProverWallet" onclick="credentialApi('createProverWallet')">Prover: Step8 -- createProverWallet</button>
</br><button id="signupForWalletAsVerifier" onclick="credentialApi('signupForWalletAsVerifier')">Verifier: Step9 -- signupForWallet</button>
</br><button id="addAuthor" onclick="credentialApi('addAuthor')">Trustee: Step10 -- addAuthor</button>
</br><button id="addEndorser" onclick="credentialApi('addEndorser')">Trustee: Step11 -- addEndorser</button>
</hr>
<h2>Do these steps in order</h2>
</br>Schema Name: <input type="text" id="schemaName" name="schemaName" value="gvt">
</br>Schema Version: <input type="text" id="schemaVersion" name="schemaVersion" value="1.0">
</br>Schema Attributes: <input type="text" id="schemaAttributes" name="schemaAttributes" value="name,age,sex,height">
</br><button id="createSchema" onclick="credentialApi('createSchema')">Author: Step7 -- createSchema</button>
</br><button id="signAndSubmitRequest" onclick="credentialApi('signAndSubmitRequest')">Endorser: Step8 -- signAndSubmitRequest</button>
</br>Credential Definition Tag: <input type="text" id="credDefTag" name="credDefTag" value="CredDefTag1">
</br><button id="createCredDef" onclick="credentialApi('createCredDef')">Author: Step9 -- createCredDef</button>
</br><button id="createMasterSecret" onclick="credentialApi('createMasterSecret')">Prover: Step10 -- createMasterSecret</button>
</br><button id="createCredOffer" onclick="credentialApi('createCredOffer')">Author: Step11 -- createCredOffer</button>
</br><button id="createCredRequest" onclick="credentialApi('createCredRequest')">Prover: Step12 -- createCredRequest</button>
</br><button id="createCredential" onclick="credentialApi('createCredential')">Author: Step13 -- createCredential</button>
</br><button id="saveCredential" onclick="credentialApi('saveCredential')">Prover: Step14 -- saveCredential</button>
</br><button id="createProofRequest" onclick="credentialApi('createProofRequest')">Verifier: Step15 -- createProofRequest</button>
</br><button id="createProof" onclick="credentialApi('createProof')">Prover: Step16 -- createProof</button>
</br><button id="verifyProof" onclick="credentialApi('verifyProof')">Verifier: Step17 -- verifyProof</button>
<h2>Delete saved agentData</h2>
</br><button id="deleteAgentData" onclick="deleteAgentData()">User: deleteAgentData</button>
</body>
</html>