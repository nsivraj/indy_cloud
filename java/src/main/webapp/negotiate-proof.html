<html>
<head>
<title>Digital Identifiers</title>
<script>
  function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires="+d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
  }

  function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i < ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) == ' ') {
        c = c.substring(1);
      }
      if (c.indexOf(name) == 0) {
        return c.substring(name.length, c.length);
      }
    }
    return "";
  }

  function deleteCookie(cname) {
    document.cookie = cname + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
    allWalletIds = [];
    trusteeWalletId = 0;
    authorWalletId = 0;
    endorserWalletId = 0;
    proverWalletId = 0;
    verifierWalletId = 0;

  }

  function saveWalletId(walletId, who) {
    let idIndex = -1;
    if(who === 'trustee') idIndex = 0;
    else if(who === 'author') idIndex = 1;
    else if(who === 'endorser') idIndex = 2;
    else if(who === 'prover') idIndex = 3;
    else if(who === 'verifier') idIndex = 4;

    let _walletIds = getWalletIds();
    _walletIds[idIndex] = walletId;
    setCookie('walletIds', _walletIds.toString(), 1000);
    console.log('saved walletIds: ', _walletIds);
  }

  function getWalletIds() {
    let _walletIds = getCookie('walletIds');
    console.log('walletIds from cookie: ', _walletIds);
    if (_walletIds != "") {
      _walletIds = _walletIds.split(',');
      for(var i=0; i<_walletIds.length; i++) { _walletIds[i] = parseInt(_walletIds[i], 10); }
    } else {
      _walletIds = [0,0,0,0,0];
    }
    console.log('found walletIds: ', _walletIds);
    return _walletIds;
  }

  //document.getElementById('issuerStep1').addEventListener('click', issuerStep1);
  //document.cookie = "username=John Doe; expires=Thu, 18 Dec 2013 12:00:00 UTC; path=/";
  var allWalletIds = getWalletIds();
  var restProtocol = 'http';
  var restHost = 'localhost';
  var restPort = 9000;
  var trusteeWalletId = allWalletIds[0];
  var authorWalletId = allWalletIds[1];
  var endorserWalletId = allWalletIds[2];
  var proverWalletId = allWalletIds[3];
  var verifierWalletId = allWalletIds[4];
  var agentData = {
    masterSecretId: '6265b3f9-ca0d-454c-b03d-dbad0a314dc8'
  };



  async function credentialApi(action) {

    let actionMethod = 'GET'
    let actionUri = 'api/'
    let actionBody = ''

    if(action === 'createTrusteeWallet') {
      actionMethod = 'GET'
      actionUri = actionUri + 'trustee/createWallet/' + trusteeWalletId
    } else if(action === 'createAuthorWallet') {
      actionMethod = 'GET'
      actionUri = actionUri + 'author/createWallet/' + authorWalletId
    } else if(action === 'createEndorserWallet') {
      actionMethod = 'GET'
      actionUri = actionUri + 'endorser/createWallet/' + endorserWalletId
    } else if(action === 'createProverWallet') {
      actionMethod = 'GET'
      actionUri = actionUri + 'prover/createWallet/' + proverWalletId
    } else if(action === 'addAuthor') {
      actionMethod = 'POST'
      actionUri = actionUri + 'trustee/addAuthor/' + trusteeWalletId
      actionBody = JSON.stringify({
        trusteeDid: agentData.trusteeDid,
        authorDid: agentData.authorDid,
        authorVerkey: agentData.authorVerkey
      })
    } else if(action === 'addEndorser') {
      actionMethod = 'POST'
      actionUri = actionUri + 'trustee/addEndorser/' + trusteeWalletId
      actionBody = JSON.stringify({
        trusteeDid: agentData.trusteeDid,
        endorserDid: agentData.endorserDid,
        endorserVerkey: agentData.endorserVerkey
      })
    } else if(action === 'createSchema') {
      actionMethod = 'POST'
      actionUri = actionUri + 'author/createSchema/' + authorWalletId
      actionBody = JSON.stringify({
        endorserDid: agentData.endorserDid,
        authorDid: agentData.authorDid
      })
    } else if(action === 'signAndSubmitRequest') {
      actionMethod = 'POST'
      actionUri = actionUri + 'endorser/signAndSubmitRequest/' + endorserWalletId
      actionBody = JSON.stringify({
        endorserDid: agentData.endorserDid,
        requestSignedByAuthor: agentData.signedSchemaRequest
      })
    } else if(action === 'createCredDef') {
      actionMethod = 'POST'
      actionUri = actionUri + 'author/createCredDef/' + authorWalletId
      actionBody = JSON.stringify({
        schemaJson: agentData.schemaJson,
        authorDid: agentData.authorDid
      })
    } else if(action === 'createMasterSecret') {
      actionMethod = 'POST'
      actionUri = actionUri + 'prover/createMasterSecret/' + proverWalletId
      actionBody = JSON.stringify({
        masterSecretId: agentData.masterSecretId
      })
    } else if(action === 'createCredOffer') {
      actionMethod = 'POST'
      actionUri = actionUri + 'author/createCredOffer/' + authorWalletId
      actionBody = JSON.stringify({
        credDefId: agentData.credDefId
      })
    } else if(action === 'createCredRequest') {
      actionMethod = 'POST'
      actionUri = actionUri + 'prover/createCredRequest/' + proverWalletId
      actionBody = JSON.stringify({
        credOffer: agentData.credOffer,
        credDefJson: agentData.credDefJson,
        proverDid: agentData.proverDid
      })
    } else if(action === 'createCredential') {
      actionMethod = 'POST'
      actionUri = actionUri + 'author/createCredential/' + authorWalletId
      actionBody = JSON.stringify({
        credOffer: agentData.credOffer,
        credReqJson: agentData.credReqJson
      })
    } else if(action === 'saveCredential') {
      actionMethod = 'POST'
      actionUri = actionUri + 'prover/saveCredential/' + proverWalletId
      actionBody = JSON.stringify({
        credential: agentData.credential,
        credDefJson: agentData.credDefJson,
        credReqMetadataJson: agentData.credReqMetadataJson
      })
    } else if(action === 'createProofRequest') {
      actionMethod = 'GET'
      actionUri = actionUri + 'verifier/createProofRequest/' + verifierWalletId
    } else if(action === 'createProof') {
      actionMethod = 'POST'
      actionUri = actionUri + 'prover/createProof/' + proverWalletId
      actionBody = JSON.stringify({
        proofReqJson: agentData.proofRequestJson,
        credDefJson: agentData.credDefJson,
        schemaId: agentData.schemaId,
        schemaJson: agentData.schemaJson,
        credDefId: agentData.credDefId
      })
    } else if(action === 'verifyProof') {
      actionMethod = 'POST'
      actionUri = actionUri + 'verifier/verifyProof/' + verifierWalletId
      actionBody = JSON.stringify({
        proofJson: agentData.proofJson,
        proofRequestJson: agentData.proofRequestJson,
        schemas: agentData.schemas,
        credentialDefs: agentData.credentialDefs
      })
    } else if(action === 'signupForWalletAsTrustee' ||
              action === 'signupForWalletAsAuthor' ||
              action === 'signupForWalletAsProver' ||
              action === 'signupForWalletAsVerifier' ||
              action === 'signupForWalletAsEndorser') {
      if((trusteeWalletId != 0 && action === 'signupForWalletAsTrustee') ||
         (authorWalletId != 0 && action === 'signupForWalletAsAuthor') ||
         (proverWalletId != 0 && action === 'signupForWalletAsProver') ||
         (verifierWalletId != 0 && action === 'signupForWalletAsVerifier') ||
         (endorserWalletId != 0 && action === 'signupForWalletAsEndorser')) {
        console.log("The action '" + action + "' has already been invoked. Verify the walletIds: ", getWalletIds());
        return;
      } else {
        actionMethod = 'POST'
        actionUri = actionUri + 'wallets/createBrandNewWallet'
        actionBody = JSON.stringify({
          secure: false
        })
      }
    }


    const fetchOptions = {
      method: actionMethod,
      headers: {
        'Content-Type': 'application/json'
      }
    }
    if(actionMethod === 'POST') {
        fetchOptions.body = actionBody
    }

    const response = await fetch(
      `${restProtocol}://${restHost}:${restPort}/${actionUri}`,
      fetchOptions
    )
    const answer = await response.json()
    console.log(action + " answer: ", answer)

    if (response.status == 200) {
      if(action === 'createTrusteeWallet') {
        agentData.trusteeDid = answer.trusteeDid
      } else if(action === 'createAuthorWallet') {
        agentData.authorDid = answer.authorDid
        agentData.authorVerkey = answer.authorVerkey
      } else if(action === 'createEndorserWallet') {
        agentData.endorserDid = answer.endorserDid
        agentData.endorserVerkey = answer.endorserVerkey
      } else if(action === 'createProverWallet') {
        agentData.proverDid = answer.proverDid
        agentData.proverVerkey = answer.proverVerkey
      } else if(action === 'addAuthor') {

      } else if(action === 'addEndorser') {

      } else if(action === 'createSchema') {
        agentData.signedSchemaRequest = answer.signedSchemaRequest
        agentData.schemaJson = answer.schemaJson
        agentData.schemaId = answer.schemaId
      } else if(action === 'createCredDef') {
        agentData.credDefId = answer.credDefId
        agentData.credDefJson = answer.credDefJson
      } else if(action === 'createCredOffer') {
        agentData.credOffer = answer.credOffer
      } else if(action === 'createCredRequest') {
        agentData.credReqMetadataJson = answer.credReqMetadataJson
        agentData.credReqJson = answer.credReqJson
      } else if(action === 'createCredential') {
        agentData.credential = answer.credential
      } else if(action === 'saveCredential') {

      } else if(action === 'createProofRequest') {
        agentData.proofRequestJson = answer.proofRequestJson
      } else if(action === 'createProof') {
        agentData.proofJson = answer.proofJson
        agentData.schemas = answer.schemas
        agentData.credentialDefs = answer.credentialDefs
      } else if(action === 'verifyProof') {
        agentData.proved = answer.proved
      } else if(action === 'signupForWalletAsTrustee') {
        trusteeWalletId = answer.walletId
        saveWalletId(trusteeWalletId, 'trustee')
      } else if(action === 'signupForWalletAsAuthor') {
        authorWalletId = answer.walletId
        saveWalletId(authorWalletId, 'author')
      } else if(action === 'signupForWalletAsEndorser') {
        endorserWalletId = answer.walletId
        saveWalletId(endorserWalletId, 'endorser')
      } else if(action === 'signupForWalletAsProver') {
        proverWalletId = answer.walletId
        saveWalletId(proverWalletId, 'prover')
      } else if(action === 'signupForWalletAsVerifier') {
        verifierWalletId = answer.walletId
        saveWalletId(verifierWalletId, 'verifier')
      }
    }
  }


</script>
</head>
<body>
<h1>Power Of Digital Credentials</h1>
<h2>Do these steps ONLY once</h2>
<button id="signupForWalletAsTrustee" onclick="credentialApi('signupForWalletAsTrustee')">Trustee: Step1 -- signupForWallet</button>
</br><button id="createTrusteeWallet" onclick="credentialApi('createTrusteeWallet')">Trustee: Step2 -- createTrusteeWallet</button>
</br><button id="signupForWalletAsAuthor" onclick="credentialApi('signupForWalletAsAuthor')">Author: Step3 -- signupForWallet</button>
</br><button id="createAuthorWallet" onclick="credentialApi('createAuthorWallet')">Author: Step4 -- createAuthorWallet</button>
</br><button id="signupForWalletAsEndorser" onclick="credentialApi('signupForWalletAsEndorser')">Endorser: Step5 -- signupForWallet</button>
</br><button id="createEndorserWallet" onclick="credentialApi('createEndorserWallet')">Endorser: Step6 -- createEndorserWallet</button>
</br><button id="signupForWalletAsProver" onclick="credentialApi('signupForWalletAsProver')">Prover: Step7 -- signupForWallet</button>
</br><button id="createProverWallet" onclick="credentialApi('createProverWallet')">Prover: Step8 -- createProverWallet</button>
</br><button id="signupForWalletAsVerifier" onclick="credentialApi('signupForWalletAsVerifier')">Verifier: Step9 -- signupForWallet</button>
</br><button id="addAuthor" onclick="credentialApi('addAuthor')">Trustee: Step10 -- addAuthor</button>
</br><button id="addEndorser" onclick="credentialApi('addEndorser')">Trustee: Step11 -- addEndorser</button>
</hr>
<h2>Do these steps in order</h2>
</br><button id="createSchema" onclick="credentialApi('createSchema')">Author: Step7 -- createSchema</button>
</br><button id="signAndSubmitRequest" onclick="credentialApi('signAndSubmitRequest')">Endorser: Step8 -- signAndSubmitRequest</button>
</br><button id="createCredDef" onclick="credentialApi('createCredDef')">Author: Step9 -- createCredDef</button>
</br><button id="createMasterSecret" onclick="credentialApi('createMasterSecret')">Prover: Step10 -- createMasterSecret</button>
</br><button id="createCredOffer" onclick="credentialApi('createCredOffer')">Author: Step11 -- createCredOffer</button>
</br><button id="createCredRequest" onclick="credentialApi('createCredRequest')">Prover: Step12 -- createCredRequest</button>
</br><button id="createCredential" onclick="credentialApi('createCredential')">Author: Step13 -- createCredential</button>
</br><button id="saveCredential" onclick="credentialApi('saveCredential')">Prover: Step14 -- saveCredential</button>
</br><button id="createProofRequest" onclick="credentialApi('createProofRequest')">Verifier: Step15 -- createProofRequest</button>
</br><button id="createProof" onclick="credentialApi('createProof')">Prover: Step16 -- createProof</button>
</br><button id="verifyProof" onclick="credentialApi('verifyProof')">Verifier: Step17 -- verifyProof</button>
<h2>Delete saved walletIds</h2>
</br><button id="deleteWalletIdsCookie" onclick="deleteCookie('walletIds')">User: deleteWalletIdsCookie</button>
</body>
</html>